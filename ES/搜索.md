# 搜索

为了充分挖掘 Elasticsearch 的潜力，你需要理解以下三个概念：

* 映射（Mapping）:描述数据在每个字段内如何存储，即类型的结构定义。
* 分析（Analysis）:全文是如何处理使之可以被搜索的。
* 领域特定查询语言（Query DSL）:Elasticsearch 中强大灵活的查询语言。

## 基础搜索功能

### 简单搜索

在所有的索引中搜索所有的类型
```
/_search
```
在 gb 索引中搜索所有的类型
```
/gb/_search
```
在 gb 和 us 索引中搜索所有的文档
```
/gb,us/_search
```
在任何以 g 或者 u 开头的索引中搜索所有的类型
```
/g*,u*/_search
```
在 gb 索引中搜索 user 类型
```
/gb/user/_search
```
在 gb 和 us 索引中搜索 user 和 tweet 类型
```
/gb,us/user,tweet/_search
```
在所有的索引中搜索 user 和 tweet 类型
```
/_all/user,tweet/_search
```

注： 搜索请求会被转发到所有分片上进行，可以是主分片，也可以是副分片

### 分页探索

使用from和size实现分页
```
GET /_search?size=5&from=10
```

注： 分布式深度分页问题：在分布式系统中，对结果排序的成本随分页的深度成指数上升。假设我们请求第 1000 页--结果从 10001 到 10010 。所有都以相同的方式工作除了每个分片不得不产生前10010个结果以外。 然后协调节点对全部 50050 个结果排序最后丢弃掉这些结果中的 50040 个结果。

### 轻量搜索

简单的查询条件
```
GET /_all/tweet/_search?q=tweet:elasticsearch
```

多个查询条件  
+前缀表示必须与查询条件匹配。类似地， - 前缀表示一定不与查询条件匹配。没有 + 或者 - 的所有其他条件都是可选的——匹配的越多，文档就越相关。
```
GET /_search?q=+name:john++tweet:mary
```

所有字段匹配（\_all特性）  
所有字段包含mary，就像是有一个\_all字段，包含文档的所有字段。可以禁用指定类型的\_all特性
```
GET /_search?q=mary
```

更复杂的查询  

* name 字段中包含 mary 或者 john
* date 值大于 2014-09-10
* \_all 字段包含 aggregations 或者 geo

```
+name:(mary john) +date:>2014-09-10 +(aggregations geo)
URL编码后可读性很差
```

## 映射（Mapping）
定义了类型中的域，每个域的数据类型，以及Elasticsearch如何处理这些域。映射也用于配置与类型有关的元数据。  
ES写入数据时，会自动判断每个域的数据类型，根据json标准；  
当然，我们可以指定各个域的映射  

* 全文字符串域和精确值字符串域的区别
	* 默认， string 类型域会被认为包含全文。就是说，它们的值在索引前，会通过 一个分析器，针对于这个域的查询在搜索前也会经过一个分析器。
	* string 域映射的两个最重要 属性是 index（索引） 和 analyzer（分析器）
	* index取值
		* analyzed：ES对String类型的默认值，首先分析字符串，然后索引它。换句话说，以全文索引这个域。
		* not_analyzed：索引这个域，所以它能够被搜索，但索引的是精确值。不会对它进行分析。
		* no：不索引这个域。这个域不会被搜索到。
	* analyzer取值
		* standard：ES默认分析器，即标准分析器；
		* simple：简单分析器
		* whitespace：空格分析器
		* english：语言分析器中的英文分析器
	* 其他简单类型（例如 long ， double ， date 等）也接受 index 参数，但有意义的值只有 no 和 not_analyzed ， 因为它们永远不会被分析。
* 使用特定语言分析器
* 优化域以适应部分匹配
* 指定自定义数据格式
* 还有更多

映射使用时有如下限制：
* 不能修改已经存在的域的映射，因为修改映射可能会导致已经被索引的数据出错，不能被正常搜索；
* 不能将一个存在的域从 analyzed 改为 not_analyzed；

## 分析（Analysis）
### 分析和分析器
分析 包含下面的过程：

* 首先，将一块文本分成适合于倒排索引的独立的 词条 ，
* 之后，将这些词条统一化为标准格式以提高它们的“可搜索性”，或者 recall

分析器执行上面的工作。 分析器 实际上是将三个功能封装到了一个包里：

* 字符过滤器
	* 首先，字符串按顺序通过每个 字符过滤器 。他们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉HTML，或者将 & 转化成 `and`。
* 分词器
	* 其次，字符串被 分词器 分为单个的词条。一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。
* Token 过滤器
	* 最后，词条按顺序通过每个 token 过滤器 。这个过程可能会改变词条（例如，小写化 Quick ），删除词条（例如， 像 a`， `and`， `the 等无用词），或者增加词条（例如，像 jump 和 leap 这种同义词）。

我们可以自定义分析器。

### 内置分析器
* 标准分析器
	* 标准分析器是Elasticsearch默认使用的分析器。它是分析各种语言文本最常用的选择。它根据 Unicode 联盟 定义的 单词边界 划分文本。删除绝大部分标点。最后，将词条小写。
* 简单分析器
	* 简单分析器在任何不是字母的地方分隔文本，将词条小写。
* 空格分析器
	* 空格分析器在空格的地方划分文本。
* 语言分析器
	* 特定语言分析器可用于 很多语言。它们可以考虑指定语言的特点。
