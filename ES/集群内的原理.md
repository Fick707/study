# 集群内的原理

## 核心概念
* cluster(集群)
* node(节点)
	* master node(主节点)
* shard(分片)

### 一些解答
* 当你的集群规模扩大或者缩小时， Elasticsearch 会自动的在各节点中迁移分片，使得数据仍然均匀分布在集群里

## 节点类型
* master node: 主节点。
* data node: 数据节点。
* client node: 负载均衡节点/路由节点。
* ingest node: 预处理节点，

### master node
* 负责集群内的所有变更，例如增加、删除索引；增加、删除节点；分片管理等；
* 主节点不涉及到文档级别的变更和搜索等操作；
* 主节点可以有多个

#### 主节点会出现的问题：
* 脑裂



### ingest node
* 它能够创建多个处理器管道，用以修改传入文档。类似最常用的Logstash过滤器已被实现为处理器
* 执行常见的数据转换和丰富。 处理器配置为形成管道。 在写入时，Ingest Node有20个内置处理器，例如grok，date，gsub，小写/大写，删除和重命名。
* 在批量请求或索引操作之前，Ingest节点拦截请求，并对文档进行处理。这样的处理器的一个例子可以是日期处理器，其用于解析字段中的日期。另一个例子是转换处理器，它将字段值转换为目标类型，例如将字符串转换为整数。



## 节点如何分配
* 对于3-5个节点的小集群来讲，通常让所有节点存储数据和具有获得主节点的资格。你可以将任何请求发送给任何节点，并且由于所有节点都具有集群状态的副本，它们知道如何路由请求。
* 对于许多用户场景，路由节点根本不一定是必需的。
* 较大的集群才能开始分离专用主节点、数据节点。
* 查询大量使用情况下路由节点更常见。（专用协调节点（也称为client节点或路由节点）从数据节点中消除了聚合/查询的请求解析和最终阶段，并允许他们专注于处理数据。）

## 分片
### 分布式文档存储
* 默认根据_id进行hash,根据下面的公式可以看到，主分片数在创建索引时指定后，不能再修改，否则文档将不能被检索到（扩容方案在后面章节）  
```
shard = hash(routing) % number_of_primary_shards
```
* 可以自定义路由参数，例如根据用户ID进行路由

### 主副分片的交互
* 新建，索引，删除都属于写操作，都需要：
	* 1. 将请求发送至主节点，根据路由规则，转发至对应主分片所在的节点；
	* 2. 执行写操作；
	* 3. 如果写操作成功，则向所有副分片执行复制操作；
* 部分文档更新稍复杂，但与上述写
* 检索文档是读操作：
	* 1. 将请求发送至主节点，根据路由规则，转发至对应分片所在的节点（一般会路由到副分片所在节点，多个副本时，轮循）； 
* 多文档操作（批量操作）时，主节点会将请求拆分成每个分片上的多文档请求。
* 多文档请求中，需要格式正确有换行符，因为这样可以省去服务端拆分多个请求的工作量；
* consistency，为了一致性，可以设置写副本的策略：
	* 1. one，即只要主分片状态OK即可以进行写操作；
	* 2. all，即只有所有主分片和副分片状态都OK时才进行写操作；
	* 3. quorum，即大多数副分片状态OK，就可以进行写操作；
	
	```
	int( (primary + number_of_replicas) / 2 ) + 1
	```
* 设置好一致性参数后，如果没有足够的节点（即分片状态不足）时，Elasticsearch会出现等待，直到timeout，默认1分钟，可以设置为其他时间值，例如100(100ms)、30s(30s)
* 要求只有当 number_of_replicas 大于1的时候，规定数量才会执行（因为es默认有一个副本，则说明至少有两个节点才能正常运行，这导致不能单机运行）

### 分片扩容