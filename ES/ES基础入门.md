# ES基础入门

Lucene是当下最先进、高性能、全功能的搜索引擎库，ES即是基于Lucene实现的开源搜索引擎；

但ES不仅仅是Lucene,它还是：  

* 一个分布式的实时文档存储，每个字段 可以被索引与搜索
* 一个分布式实时分析搜索引擎
* 能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据

## 索引
* 索引实际上是指向一个或者多个物理 分片 的 逻辑命名空间 
* 应用与索引交互，而不是与分片交互


## 分片
* 一个分片是一个 Lucene 的实例，它本身就是一个完整的搜索引擎
* 一个分片可以是 主 分片或者 副本 分片
* 索引内任意一个文档都归属于一个主分片，所以主分片的数目决定着索引能够保存的最大数据量
* 技术上来说，一个主分片最大能够存储 Integer.MAX_VALUE - 128 个文档，但是实际最大值还需要参考你的使用场景：包括你使用的硬件， 文档的大小和复杂程度，索引和查询文档的方式以及你期望的响应时长。
* 索引建立的时候就已经确定了主分片数，但是副本分片数可以随时修改。

### 副分片
* 一个副本分片只是一个主分片的拷贝
* 副本分片作为硬件故障时保护数据不丢失的冗余备份
* 为搜索和返回文档等读操作提供服务。
* 因为副分片也能处理搜索服务，所以添加副分片也能增加吞吐量。但如果节点数不变，增加副本并无意义


## 文档
### es文档元数据
* \_index:文档所属索引
* \_type:类型
* \_id:唯一索引
* \_version
* \_seq_no
* \_primary_term
* \_source

### 一些注意的点
* 如果根据id检索某文档时，该id并不存在，则返回404http响应，且响应码中的found=false
* 检索文档可以只要求返回部分字段，只需要在请求参数中，添加类似_source=title,text的参数，多个字段用逗号分隔
* 如果只需要返回_source，而不需要返回元数据字段，则直接用形如GET /website/blog/123/_source的请求即可
* 用put请求更新文档是将旧文档标记为删除，新建一个文档代替，版本号升级。后台程序删除旧文档
* 用update api可以部分更新文档，看似直接修改文档，但也是按上述方式进行
* 用upsert参数可以进行update or insert操作
* 删除文档的操作也是将文档标记为删除，后台程序根据策略后期删除
* mget api可以一次获取多个文档
* bulk 操作是一次进行多个操作，饮食create,update,delete,index等
	* create  
	如果文档不存在，那么就创建它。
	* index  
	创建一个新文档或者替换一个现有的文档。
	* update  
	部分更新一个文档。详情请见 文档的部分更新。
	* delete  
	删除一个文档。详情请见 删除文档。
* 批量操作不能一次操作过多的文档，如果文档操作时占用内存超过15M就可能引起性能下降了


### 冲突处理
有两种方式处理并发更新时数据一致性

* 悲观并发控制  
	这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。 一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。
* 乐观并发控制  
	Elasticsearch 中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。
